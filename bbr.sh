#!/bin/bash

# ========================
# ğŸ“Œ å¸¸é‡å®šä¹‰
# ========================
declare -A SYSCTL_SETTINGS=(
    # TCPæ¥æ”¶ç¼“å†²åŒºçš„æœ€å°ã€é»˜è®¤ã€æœ€å¤§å€¼ï¼ˆå•ä½ï¼šå­—èŠ‚ï¼‰
    ["net.ipv4.tcp_rmem"]="4096 87380 6291456"
    # TCPå‘é€ç¼“å†²åŒºçš„æœ€å°ã€é»˜è®¤ã€æœ€å¤§å€¼
    ["net.ipv4.tcp_wmem"]="4096 87380 6291456"
    # æ¥æ”¶ç¼“å†²åŒºçš„æœ€å¤§å¤§å°
    ["net.core.rmem_max"]=33554432
    # å‘é€ç¼“å†²åŒºçš„æœ€å¤§å¤§å°
    ["net.core.wmem_max"]=33554432
    # FINè¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œå‡å°‘TIME_WAITçŠ¶æ€æŒç»­æ—¶é—´
    ["net.ipv4.tcp_fin_timeout"]=20
    # å…è®¸é‡ç”¨TIME_WAITçŠ¶æ€çš„è¿æ¥
    ["net.ipv4.tcp_tw_reuse"]=1
    # å¯ç”¨TCPçª—å£ç¼©æ”¾ä»¥æ”¯æŒé«˜å»¶è¿Ÿé«˜å¸¦å®½è¿æ¥
    ["net.ipv4.tcp_window_scaling"]=1
    # é»˜è®¤æµé‡é˜Ÿåˆ—è§„åˆ™ï¼Œä½¿ç”¨å…¬å¹³é˜Ÿåˆ—(fq)
    ["net.core.default_qdisc"]="fq"
    # ä½¿ç”¨BBRæ‹¥å¡æ§åˆ¶ç®—æ³•
    ["net.ipv4.tcp_congestion_control"]="bbr"
    # å¯ç”¨TCP Fast Openï¼ˆ3=å®¢æˆ·ç«¯+æœåŠ¡ç«¯ï¼‰
    ["net.ipv4.tcp_fastopen"]=3
    # Keepaliveæ£€æµ‹ç©ºé—²è¿æ¥é—´éš”ï¼ˆç§’ï¼‰
    ["net.ipv4.tcp_keepalive_time"]=300
    # Keepaliveæ¢æµ‹é—´éš”ï¼ˆç§’ï¼‰
    ["net.ipv4.tcp_keepalive_intvl"]=75
    # Keepaliveæ¢æµ‹æ¬¡æ•°
    ["net.ipv4.tcp_keepalive_probes"]=9
    # å¯ç”¨SYN Cookiesé˜²å¾¡æ´ªæ°´æ”»å‡»
    ["net.ipv4.tcp_syncookies"]=1
    # SYNé˜Ÿåˆ—æœ€å¤§é•¿åº¦
    ["net.ipv4.tcp_max_syn_backlog"]=8192
    # SYN-ACKæœ€å¤§é‡è¯•æ¬¡æ•°
    ["net.ipv4.tcp_synack_retries"]=2
    # æœ¬åœ°ç«¯å£èŒƒå›´
    ["net.ipv4.ip_local_port_range"]="1024 65535"
)

CONFIG_FILE="/etc/sysctl.d/99-bbr.conf"
MODULES=("tcp_bbr")  # BBRä¾èµ–çš„å†…æ ¸æ¨¡å—

# ========================
# ğŸ“Œ å·¥å…·å‡½æ•°
# ========================
die() {
    printf "\033[31m[é”™è¯¯] %s\033[0m\n" "$*" >&2
    exit 1
}

info() {
    printf "\033[34m[ä¿¡æ¯] %s\033[0m\n" "$*"
}

check_command() {
    if ! command -v "$1" >/dev/null 2>&1; then
        die "æœªæ‰¾åˆ°å‘½ä»¤: $1 (å°è¯•å®‰è£…: ${2:-unknown})"
    fi
}

check_root() {
    [ "$(id -u)" -eq 0 ] || die "è¯¥è„šæœ¬å¿…é¡»ä»¥ root æƒé™è¿è¡Œï¼"
}

validate_setting() {
    local key=$1
    local expected=$2
    local actual
    actual=$(sysctl -n "$key" 2>/dev/null | xargs)
    expected=$(echo "$expected" | xargs)

    if [ "$actual" != "$expected" ]; then
        die "$key è®¾ç½®å¤±è´¥ (å½“å‰: '${actual}', æœŸæœ›: '${expected}')"
    fi
}

# æ£€æŸ¥å†…æ ¸æ¨¡å—æ˜¯å¦å¯ç”¨ï¼ˆå·²åŠ è½½æˆ–å†…ç½®ï¼‰
module_available() {
    local module=$1
    grep -qw "^${module}" /proc/modules || [ -d "/sys/module/${module}" ]
}

# ========================
# ğŸ“Œ ä¸»é€»è¾‘
# ========================
main() {
    # é¢„æ£€
    check_root
    check_command sysctl procps
    check_command modprobe kmod

    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬ â‰¥ 4.9
    local kernel_ver
    kernel_ver=$(uname -r | awk -F. '{ printf("%d%02d", $1,$2) }')
    if [ "$kernel_ver" -lt 409 ]; then
        die "éœ€è¦ Linux å†…æ ¸ â‰¥ 4.9 (å½“å‰: $(uname -r))"
    fi

    # æ£€æŸ¥BBRæ˜¯å¦å¯ç”¨
    if ! grep -qw bbr /proc/sys/net/ipv4/tcp_available_congestion_control; then
        die "å½“å‰å†…æ ¸ä¸æ”¯æŒ BBR æ‹¥å¡æ§åˆ¶ç®—æ³•ã€‚"
    fi

    # åŠ è½½å¿…è¦å†…æ ¸æ¨¡å—
    for module in "${MODULES[@]}"; do
        if ! module_available "$module"; then
            info "æ­£åœ¨åŠ è½½å†…æ ¸æ¨¡å—: ${module}..."
            if ! modprobe "$module" 2>/dev/null; then
                die "æ— æ³•åŠ è½½æ¨¡å— ${module}ï¼Œè¯·æ£€æŸ¥å†…æ ¸é…ç½®ã€‚"
            fi
        fi
    done

    # è®¾ç½®å¹¶éªŒè¯sysctlå‚æ•°
    info "æ­£åœ¨ä¼˜åŒ–ç³»ç»Ÿç½‘ç»œå‚æ•°..."
    for key in "${!SYSCTL_SETTINGS[@]}"; do
        sysctl -w "$key=${SYSCTL_SETTINGS[$key]}" >/dev/null
        validate_setting "$key" "${SYSCTL_SETTINGS[$key]}"
    done

    # æŒä¹…åŒ–é…ç½®ï¼ˆè‡ªåŠ¨å¤‡ä»½æ—§æ–‡ä»¶ï¼‰
    info "æ­£åœ¨ä¿å­˜é…ç½®åˆ° ${CONFIG_FILE}..."
    if [ -f "$CONFIG_FILE" ]; then
        local backup="${CONFIG_FILE}.bak-$(date +%s)"
        cp -v "$CONFIG_FILE" "$backup"
    fi
    {
        echo "# Generated by $(basename "$0") at $(date)"
        for key in "${!SYSCTL_SETTINGS[@]}"; do
            echo "${key}=${SYSCTL_SETTINGS[$key]}"
        done
    } > "$CONFIG_FILE"
    chmod 644 "$CONFIG_FILE"

    # åº”ç”¨é…ç½®
    if ! sysctl -p "$CONFIG_FILE"; then
        die "æŒä¹…åŒ–é…ç½®åº”ç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ ${CONFIG_FILE} å†…å®¹ã€‚"
    fi

    # é‡å¯systemd-sysctlæœåŠ¡ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if systemctl is-active systemd-sysctl &>/dev/null; then
        info "æ­£åœ¨é‡å¯ systemd-sysctl æœåŠ¡..."
        systemctl restart systemd-sysctl
    fi

    # æœ€ç»ˆéªŒè¯
    info "å…³é”®å‚æ•°éªŒè¯:"
    local cc_result
    cc_result=$(sysctl -n net.ipv4.tcp_congestion_control)
    if [ "$cc_result" = "bbr" ]; then
        printf "\033[32m[æˆåŠŸ] TCPæ‹¥å¡æ§åˆ¶ç®—æ³•å·²è®¾ç½®ä¸º BBRã€‚\033[0m\n"
    else
        die "TCPæ‹¥å¡æ§åˆ¶ç®—æ³•è®¾ç½®å¤±è´¥ï¼Œå½“å‰ä¸º ${cc_result}ã€‚"
    fi

    local qdisc_result
    qdisc_result=$(sysctl -n net.core.default_qdisc)
    [ "$qdisc_result" = "fq" ] || die "é»˜è®¤é˜Ÿåˆ—è§„åˆ™è®¾ç½®å¤±è´¥ï¼Œå½“å‰ä¸º ${qdisc_result}ã€‚"

    printf "\n\033[32mâœ… æ‰€æœ‰ä¼˜åŒ–å·²æˆåŠŸåº”ç”¨ï¼\033[0m\n"
}

main "$@"
